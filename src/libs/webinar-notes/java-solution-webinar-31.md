---
title: 技术方案 Webinar - 锁和并发
date: 2023-07-08 20:54:03
sidebar: true
head:
- - meta
- name: keyword
  content:  锁和并发
  description:  应用系统中常见的并发问题和方案，以及锁的使用。
---

## 什么是并发？

定义：并发不是性能和数量问题，而是多用户对资源（数据、计算）竞争的问题。排除网络资源、硬件资源，因为被操作系统和框架抽象了。

## 有哪些应用开发下的并发场景？

- 多用户对同一个数据资源的并发更新，例如多个用户编辑同一个文章。大概得解决方案就是行锁、分布式锁、乐观锁、租户隔离。大部分竞争都是该类型，只是颗粒度问题。
  - 表级别
  - 行级别
  - 全局（整个系统）级别
- 数据资源竞争并发实例
  - 普通行级业务并发更新
  - 用户名注册，抢号
  - ID 生成或者单号生成
  - 数据排序
  - 库存占用和扣减问题
- CPU 资源并发问题，例如网关对线程的资源竞争
  - 比如使用 Vert.x、webFlux、Erlang-OTP 等非阻塞的框架
- 磁盘的并发、网络并发，这个很少见不讨论

## 并发问题背后的逻辑和抽象是什么？

- 理论层
  - 争用和同步：哲学家进餐问题
  - 死锁：AB 同时需要互相锁住对方
  - 活锁：AB 同时需要互相锁住对方，但是又同时释放锁，好比在一个相向的两个人互相让对方。
  - 并发能力的度量
    - 性能方面：限定资源的情况 QPS、TPS 指标
      - 使用测试工具 K6、Jemeter、Locust
    - 资源利用效率的方面：没人做，资源便宜，很多不平衡为常态，最近有些公司会有监控，利用过低会被考核（大型的公司）
    - 容量：无限资源（单位时间内可扩容的资源）的情况 QPS、TPS 指标。
      - 如何测算出系统容量？
      - 难点是增长曲线不是线性的，很难准确测试出结果
- 操作系统层面资源竞争
  - CPU（体现在线程）
  - 对象池中的对象
  - 连接池中的网络连接
  - 文件描述符
- 数据库层面
  - 行锁
  - 表锁
- 程序层面
  - 线程安全
  - 全局资源
  - 单例资源同步问题

## 有哪些解决并发问题的工具（例如锁）？

- 分布式锁（全局锁，与被锁业务数据无关的场景适用）
  - Redis 锁，Redission 框架 【应用推荐，权衡了可靠性和性能之间的平衡】
  - ZK、etcd 数据和分布式系统要求高的场景使用
  - 数据库（Memo 存储引擎）【不常用，时间问题，支持的框架比较少】
- 数据库的行锁、表锁  
  - 排它锁，select for update
  - 优点是极其简单，不需要额外的支持和框架，以及配置和字段
  - 缺点是性能太差，行锁经常被写成表锁
  - 尽量优化数据模型，避免竞争
  - 数据敏感性的场景还是需要的
  - 适用于竞争烈度高的地方，频繁失败的场景，造成等待
- 数据库的乐观锁
  - 方案一：使用 version 通过比较 version 的版本来实现更新
  - 方案二：一些满足适用业务值的场景可以直接使用业务值字段，比如 stock
  - 优点是性能高，特别是没有竞争烈度的场景下可以做到无锁
- 进程内的锁工具
  - Cow 的技巧，copy on write，对大规模更新效果比较好
  - ThreadLocal 借用线程的上下文，提高并发，隔离线程，相当于通过空间换取竞争
  - AtomicInteger 解决 int 自增的问题，并发下进行计数操作
  - synchronized 原生
  - volatile 内存可见性问题、禁止重排 
  - ReentrantLock，J.U.C 的实现可重入锁 【用的比较少】简单的理解：synchronized 是一个关键字，ReentrantLock 是程序化或者框架的实现，提供更多的功能。
- 并发框架
  - Disruptor 
- 非阻塞 IO 框架和方案，一般用于网关方案，因为领域服务的并发问题不在 IO 上，往往和业务和数据资源有关，下面这些方案都是对 IO 密集的处理：
  - webFlux 【网关推荐，业务不推荐】
  - Vert.x
  - erlang-OTP
  - Nodejs 【问题比较多，不推荐】
  - 异步的数据库库

## 多高的并发算高并发呢？

- 领域服务，常规业务单机 4U 8G，2000 TPS
- 网关，一个中心的并发需要做到，QPS 和 TPS 2-4 万
- 整个系统容量
- 日均 10 亿
  - 100 pod，单台 600-700 QPS、TPS
  - 应用网关（BFF）：4W 左右
  - 网络网关（网络）：百万、千万级别

高并发的思想：**通过业务因子快速定位数据（分片缩小范围）、避免竞争、避免内存联表计算、谨慎磁盘操作、禁止联机应用做分析类工作。**

## 并发问题其他注意事项

- 分布式锁的使用注意事项
  - 分布式锁是一个同步协调机制，不能依赖分布式锁作为数据唯一性的验证，应该通过数据库唯一键实现，找到业务上的幂等因子。
  - 设置过期时间防止超时占用的问题自动释放，如果时间设置过低，会出现锁丢失情况，如果时间设置过长，会阻塞。
- 锁
  - 对象头的问题
  - 锁升级问题
- 并发测试和资源泄露检测方案
  - 浸泡测试 tempus-fugit
  - VisualVM
  - JMH 微基准测试

## 推荐书籍

- 《操作系统导论》

## 关键评论

- Thinking in Java里提到过，说并发的问题就是难以复现，不好测试
- 赞，好几次的并发和性能问题，都是因为OLTP和OLAP混在一起搞了

## 录屏

链接: https://pan.baidu.com/s/1BlzR5_H5BExXIYQUuLT6LA?pwd=byv4 提取码: byv4 复制这段内容后打开百度网盘手机App，操作更方便哦

## 参考资料

- Java 全栈知识体系 https://pdai.tech/
