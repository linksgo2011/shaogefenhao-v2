---
title: Java 常见技术方案讨论 1
date: 2022-10-15 18:27:46
sidebar: true
head:

-
    - meta
    - name: keyword
      content: Java 常见技术方案讨论 1
      description: Java 常见技术方案讨论 1

---

## 会议信息

会议主题：Webinar for Java Common Solutions
会议时间：2022/10/15 21:00-22:30 (GMT+08:00) 中国标准时间 - 北京
重复周期：2022/10/15-2022/11/26 21:00-22:30, 每周 (周六)

点击链接入会，或添加至会议列表：
https://meeting.tencent.com/dm/3hmMzJplIFc0

腾讯会议：438-7768-4480

## Agenda 和准备材料

1. 讨论的形式和话题话题枚举
    2. 要录屏吗？录屏
    3. 讨论维度是什么？
        4. 不同项目的工作中方案？不同的项目都是怎么做的？ 有哪些坑？
        5. 方案优点，亮点
        6. 方案缺点，局限性
        7. 其他可选的代替方案
        8. 推荐主流的方式
        9. 没有参考案例资料
    4. 产出是什么？整理成会议纪要，更像是一种方案盘点
    5. 原则：以严肃对待、生产可用、深入为原则。避免 "这个很简单，但是项目总是会发生问题"。
2. 本次讨论的议题，例如："业务单号生成实现的最佳方案"

### Java solutions 议题常用话题参考

1. 如何检查业务输入？启动一个新的项目需要要求产品/BA 提供那些业务材料？
2. 如何做概要设计？概要设计做到什么程度？产出物是什么？
3. 如何做详细设计？详细设计做到什么程度？如何管理开发过程中和详细设计不一致的情况，如何保持设计文档更新？
4. 典型的微服务的结构是什么样的？每个项目的微服务结构有哪些差异？
5. CRUD 无脑方案，有哪些主流技术选型? 优缺点是什么？如何做到性能可靠、类型安全、冗余代码少、方便抄代码？
6. 实现 Auth 和用户中心设计的主流方式是什么？
7. 实现通用权限的方案是什么？怎么实现权限配置？基于什么做权限配置？在哪里做权限检查？
8. 数据字典的最佳实践是什么样的？
9. 导入导出的方案有哪些，主流的做法是什么？
10. 不同时区的问题怎么解决？数据库和 Java 代码推荐使用什么具体的数据类型？
11. 多语言怎么设计？语言包怎么管理？
12. 全球部署的应用本地数据不运行出境如何实现？
13. 分布式锁的实现最佳方案？
14. 一致性实现和分布式事务的推荐解决方案和思路？
15. 缓存的最佳实践是什么？如何设计良好的失效策略？
16. 业务单号生成实现的最佳方案？
17. ID 类型的选择和生成方式最佳方案是什么？
17. 软删除方案中比较好和透明的做法是什么，哪些数据需要软删除？什么情况下不要使用软删除？
18. 数据掩码加密，哪些数据算敏感数据？如何对数据库的敏感数据字段加密，加密后如何解决运维问题？
19. 如何做数据迁移？如何安全的对线上数据进行修复？如何校验迁移后的数据是可靠的？
20. 服务之间调用有哪些方案？推荐什么形式？使用二方包？
21. 一般性能指标有哪些？实际项目中最具有参考价值的是什么？
22. 系统数据容量怎么计算？如何对历史数据归档？
23. 建模的坏味道，建模的原则

## 《业务单号生成实现的最佳方案》讨论记录

邓老师抛出业务背景和基本方案： 需要业务场景生成业务有意义的编号，比如药品编号。

解决方案：

```text

1. 业务提供一个模板，比如 "YYYY-xxx"来生成业务单号，使用前端调用后端提前（申请式）生成，因为需要在受理业务的时候（还没持久化）就能看到，缺点就是会浪费一些没有存下来的单号。
2. 后端实现为存储了一个当前生成的最大值，如何保证唯一性？连续性？有序性？并发性？可用性？
3. 唯一性使用 Redis 锁最大值实现，可能性能上有瓶颈，但是目前能满足大部分场景，需要在 Redis 配置持久化选项，可以按照周期重置起点。使用 Redission 的原子性操作实现自增，开发者不用关心锁的问题。
4. 业务上不用连续性，也不可能做到连续性。
5. 有序性使用 Redis 的自增特性。
6. 并发性依赖 Redis 的性能，因为生成业务单号逻辑比较简单，并发一般可以接受。

可选方案：

1. 使用数据库行锁，设计一张表，每个前缀一行存储最大值作为计数器，使用 SQL 类似：max = max+1，可以使用 MYSQL 的内存存储引擎。
2. 使用表锁，每次 select max(no) + 1 然后 insert 一条数据到数据库。
3. 使用两张表，一张计数器表（可以使用 Redis 代替） + 单号表，这样避免使用表锁，但是行锁也需要，但是增加了表的数量。
4. 使用 Java 来生成，每个机器的 ID 编入编号，类似于雪花算法，适合 UUID，这个不适合具有业务编号的生成。
5. Range 算法，前面的本质是自增步长为 1，自增步长可以为 N，在内存中使用，顺序性可能受到一定的破坏，服务重启后会浪费一定单号，适合高并发。可以有单独一个服务，但是需要维护。

问题：

1. 如果需要保证连续性怎么做？

比如生成卡号。这个不是一个技术问题，这是一个业务逻辑问题。方案必须要能接受看到的时候和最终持久化的不一致。

2. 多个微服务都需要生成单号怎么设计？如果使用数据库的方案，每个服务都需要生成数据库。

参考下面的解决方案：

   1. 使用 Redis 的方案，使用 SDK 即可，不同的服务配置不同的 Prefix。
   2. 在每个服务中创建独立的计数器表，也可以使用 SDK，并配置一个数据库表和数据源
   3. 使用一个公共服务，比如基础功能服务承载此类需求
   4. 每个服务单独实现一套

推荐方案：

1. 当业务上预生成的单号都需要被管理和跟踪，可以优先考虑使用数据库。
2. 只是单纯的生成一个单号，使用 Redis 比较简单，如果没有 Redis 基础设施，可以可以使用数据库。

遇到的坑：

1. 使用 select count(0) 来获取最大的值，但是这样就需要保证数据不能被删，否则会出现错误，新的单号会重复。
2. Max Value 丢失，Redis 没有持久化或者被删除。解决方案是，手动的提取业务单号的最大值，或者系统启动时候检查，自动修复一次。
3. 如果采用了锁表的方案，会出现性能问题。

```

## 关于后续活动的反馈：

1. 对话题进行分类
2. 将这些整理出来放到一个共享的地方。暂时先放到博客上增加评论功能，后续整理下发布到单独的仓库
3. 后续的活动的安排
4. 将业务单号生成实现为 library，用于后续项目使用

## 录屏和文件分享

链接: https://pan.baidu.com/s/19yp9cUGVrVNz24YkG8OcdQ 提取码: a199 
