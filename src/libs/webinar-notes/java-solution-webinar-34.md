---
title: 技术方案 Webinar - 金额和高精度计算问题
date: 2023-07-29 20:54:03
sidebar: true
head:
- - meta
- name: keyword
  content:  金额计算，高精度计算
  description:  高精度计算
---

## 项目中的金额计算有什么问题？

- 精度丢失
  - double 是浮点数，而在高精度计算的场景中，我们需要定点数。
  - 在业务自然世界中 "0.00056" 是一种定点数，在计算机中 double 是浮点数，浮点数的特点是容量大，但是做了模糊化处理。
- 预期结果不稳定
- 数据类型容量超限制，自动截取
- 舍入问题
- 抹零
- 国际货币换算问题和汇率

## 常见的解决方案有哪些？

- 如何解决金额计算问题，使用什么数据结构?
  - INT/LONG 通过人民币的分来计算，余额使用存储为分，如果是小数计算乘以一个精度值比如 10000，最后做除法获取最终结果。
    - 好处是完全能控制精度问题，但是侵入业务。
    - 不推荐使用这种做法，但是一些遗留系统还会有。
  - 一些电商类的项目使用 Double 来处理，会出现一些问题
- BigDecimal 来实现，Java 中自带，JavaScript 中需要使用对应的库来进行计算
- 舍入方式
  - 电商：使用向下取整，并使用最后一个分割进行抹零（对前面的结果使用减法，而非除法，其结果相加必然持平）。
  - 金融项目：四舍五入 ROUND_HALF_UP，取决业务需求。

## 有那些坑？

- BigDecimal 的数据传输形态
  - 使用字符串，不使用字符串会出现各种问题
- BigDecimal 初始化，两种初始化方法
  - new BigDecimal("0.01") 【推荐】
  - BigDecimal.valueOf(0.01）【其次推荐】
- Spring Boot 如果是 BigDecimal 默认转换 JSON 时为数字，精度会丢失，需要自己设置转换。
- 5*b*(1/5) 在计算过程中能够内联的优先内联，公式顺序会对精度有影响，需要优化。
- BigDecimal 除法报错，因为除法需要人为干预来进行精度选择

## 价格单问题

- CRM、电商、金融中关于价格单领域问题
  - 在很多领域，关于价格的问题都是通过价格单实现的，和供应商、时间、品类、地区、折扣、活动等相关。
- 价格
  - 成本价：企业自己核算的价格。
  - 出货价：给供应商提供的价格。
  - 销售价：给终端的建议价格或者零售价格。
  - 折扣价：折扣计算后的价格。
  - 历史价：定价历史。
- 最重要的定价一般都是出货价，因为是企业面向供应商的直接价格，而零售价格一般是指导价格。
- 对出货价计算的方案一般是维价单
  - 供应商、生效时间、品类、地区怎么设计在一个维价单上？
  - 方案一：价格表、维价单表，如果定价单生效，动态刷新价格表
    - 定价维度：SPU（机型或者最小库存单位）、SKU（最小销售单位）、SN（唯一序列号）、批次（涉及先入先出问题，某些期货性质的价格可能会根据策略浮动）。
    - 价格刷新时（甚至提前写入），是写入新的数据和生效时间，对老的数据进行关闭，并且记录相关时间。
    - 历史价格和价格表是一个表，不会拆分开。
  - 方案二：直接使用定价单的表，在取价格时动态提取。【这个方案不推荐】
- 折扣问题
  - 折扣价格也会写入价格表，作为一个字段出现，可能也会有生效时间，一般是两个字段一行数据，不会是两行数据。
- 活动的问题
  - 使用一个单独的活动服务，通过创建虚拟的商品、劵来处理活动，这些过程会被计入营销成本。
  - 营销成本和供应商分摊的问题，一般是独立的服务且和财务结算有极强的关联。
- 在于销售价的方案一般是定价单

## 录屏

链接: https://pan.baidu.com/s/11wAtaK1heDaPKOJEGiQ9jA?pwd=sw5b 提取码: sw5b 复制这段内容后打开百度网盘手机App，操作更方便哦


## 潜在话题

- CRM 或者电商中的财务问题。

