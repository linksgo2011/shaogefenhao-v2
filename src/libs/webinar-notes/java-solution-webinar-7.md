---
title: 技术方案 Webinar - 分库分表和数据库选型
date: 2022-12-03 21:00:00
sidebar: true
head:
- - meta
- name: keyword
  content: 分库分表和数据库选型
  description: 分库分表和数据库选型
---

## 录屏和文件分享

## 话题聚焦

如何做数据库（关系型）选型和分库分表方案？

## 问题

1. 为什么做分库分表？解决了什么业务、技术问题？

数据量大。一般来说，数据量到达千万级别就需要分库分表，这句话是对 MySQL 和 PGSQL 而已，Oracle、DB2 不存在这个问题。

原因：DB2 是企业级、金融级的大型数据库，一般部署到小型机器；Oracle 可以支持更高的硬件和数据量，也有数据库分片的原生机制，比 MySQL 好，所以不需要特别考虑应用层折腾的事情。

使用 MySQL + 开源的分库分表相当于一套商业的分布式数据库系统（TiDB、TDSQL for Mysql、高斯DB）。TiDB 的核心存储使用了 Key-Value 的持久化，对外支持 MySQL 5.7 协议，支持 OLAP、OLTP，CAP 定理上的权衡是可用性优先和 MongoDB 类似。

2. 在什么数据规模下，MySQL 需要分库分表？

按照经验，在千万左右，MySQL 需要拆分；按照阿里的规范推荐在 500W 条数据左右需要拆分。这里的数据是热数据，如果是冷数据可以先不考虑分库分表。

3. 怎么做？那些数据库原生支持？那些需要应用侧来做？ 

前提是排除 Oracle、DB2、SQLServer，原因是贵、运维麻烦、去 A 的政策合规原因，排除垂直分库的情况。

- 使用 NewSQL 商业数据库支持
  - 腾讯 TDSQL，有两个版本，一个 MySQL 内核版本（甲骨文社区版本），一个腾讯自研内核。支持三种模式：No Sharding、Group Sharding、读写分离模式。Group Sharding 使用 Proxy 的方式实现，类似于 Mycat。
  - PingCap 公司的TiDB，原生的分布式数据库。猜测：和 MongoDB 类似，可用性优先。
  - 华为：高斯 DB，类似 TDSQL，基于 PGSQL 作为内核。
  - 阿里：Polar DB。
- 使用开源的中间件、Lib 来实现
  - MyCat：proxy 模式，引入一层中间层，对客户端透明，性能受损，开源社区不活跃。
  - Sharding JDBC：lib 模式，客户端依赖包，对业务侵入大，灵活机动，开源社区活跃。
- 其他做法
  - 使用 MySQL 自带分区机制，先垂直分库，再对大表分区。只有 HASH 策略，不能根据业务增长，增加分区。
  - 不使用开源中间件，直接在应用代码中手动处理。
  - 冷热分离（数据老化），将数据定期同步到老数据库去，老数据只查不写入。缺点是，查询必须带时间条件，或者单独开历史查阅接口。

4. 分库分表后遇到了什么问题吗？

在分页的情况下，跨表查询、排序、统计。比如查询条件不是分库的 Sharding Key，这时分页非常麻烦。

- 不保证搜索分页准确性。
- 二次排序，先把不同的表的结果集提出来，在排序，这个适合 Proxy 模式，应用端无感，但是 Proxy 容易变成单点和性能瓶颈。
- 使用 ES，查询不走关系数据库，直接读写分离。成本非常高，需要实现数据库到 ES 的同步问题。

在分库分表的情况下 Join 的问题。

- 很多系统对于分区表不用 Join。


## 案例演练

假如月均数据量 30W，活跃数据保留 3-5 年，3 年后数据量达到 30*12*3 = 1080W 数据，五年后达到 30*12*5 = 1800W；不能使用 Oracle、SqlServer 、Db2；假定字段数量 30 个。


## 设计策略

- 优先分库还是分表？
- 拓展怎么做？
- 怎么选分区健？

## 录屏分享

2022-12-03 分库分表和数据库选型.mp4

链接: https://pan.baidu.com/s/1NeQyn3CxByAvLetRHsGDAg?pwd=7fwi 提取码: 7fwi 复制这段内容后打开百度网盘手机App，操作更方便哦




