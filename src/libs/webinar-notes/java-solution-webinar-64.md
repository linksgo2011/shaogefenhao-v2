---
title: 技术方案 Webinar - 数据同步
date: 2024-07-27 20:54:03
sidebar: true
head:
- - meta
- name: keyword
  content: 数据同步
  description:  数据同步
---

## 背景

我已经把部分内容整理到，这篇文章： https://shaogefenhao.com/posts/architecture/data-synchronization.html#_01-%E5%90%8C%E6%AD%A5%E7%AD%96%E7%95%A5

下面是基于这篇文章的讨论。

## select 模式设置多大的 payload 比较合适？

- 考虑数据库性能、Java 内存大小，例如 50条数据就够了。
- 通过实践调整和优化的。
- 很难说一个具体的数字。

## Select 模式下，一般定时多少刷一次？

- 看业务敏感性，分钟级（5分钟），或者小时级别同步，算是微批同步。
- 特殊情况下也能做到秒级（死循环，可阻塞的定时器）
- 后台任务:或者叫守护进程，一直在跑死循环。定时任务：定时器。
- Select 也可以使用 MQ，这样分摊压力，读写的压力分离。
- 任务触发和管理可以使用 Airflow 实现复杂的数据流编排，例如 DAG 模型

## 备注

- ClickHouse 引擎直接支持数据增量，类似数仓的数据库有些支持。但是关系型数据库，目前好像都不支持。
- 除了 CDC 也可以直接在业务层把事件发送出去。
- Select 模式落地时【目标库】用一个临时表，然后再转存进去。做一次同库转存，提高数据操作安全性。Select into 高效转存。解决什么问题：可能忘记改同步脚本中的字段，业务库字段更新了，同步脚本直接把脏数据写进了目标库。考虑外部的数据结构不一致，来匹配目标数据库的一致。这个临时表不一定需要，数据来源不可控或者不可信任。
- Select 最好读数据源的从库。
- 业务上数据同步和数仓有一个微妙的关系，有些公司不希望走数仓（分层架构），而有些公司希望构建点对点数据同步。取决于是否是数据加工，走数据集市，一般数仓都是 T+1。数仓平台一般带一个ETL、或者数据迁移工具，例如 Datax。
- Select 的另一种实现，增加一个字段来标记是否同步，应用层需要配合，比如有更新需要标记是否需要同步。
- Select 可以并行做，使用多个线程处理。
- 使用 update_time 需要增加一个窗口时间，增加同步安全性。
- 数据对账，根据条数来验证是否同步完。
- 使用 AK 机制，实现精确一次同步，但使用 Select 对顺序没有要求，所以不需要精确同步。
- 传输协议握手，版本确认
- 记得加索引，命中 update_time, B-Tree 刚好合适
- 第三方平台，不能同时连接两边数据库，需要使用 MQ、HTTP 链接通过分解源端和目标端。
- 直接在应用代码中发送事件，实现数据同步，需要定时补偿一次，数据对账。（推、拉视角）

## 录屏

- https://www.bilibili.com/video/BV16HvEePEsx/
