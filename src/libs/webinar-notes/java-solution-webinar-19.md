---
title: 技术方案 Webinar - CI/CD 之流水线搭建、质量扫描、测试策略
date: 2023-03-18 20:49:02
sidebar: true
head:
- - meta
- name: keyword
  content: 流水线搭建、质量扫描、测试策略
  description: 流水线搭建、质量扫描、测试策略
---

## 什么是流水线？

一套持续构建和交付的基础设施，用来自动化的构建和发布软件单元，可以像工厂流水线一样构建出可交付的软件。

## 如何设计流水线？

- 有哪些流水线工具或者平台可以使用？
  - Jenkins 
  - GoCD
  - Github Actions
  - Gitlab Devops
  - 华为伏羲
  - 阿里云效
  - Bamboo
  - 微软 Azure
  - Ping Code
- 有哪些概念？
  - Stage 阶段：可以完成一个完整目标，例如构建 Jar 或者 Docker 镜像
  - Step： 为了完成一个 Stage 具体的操作，比如拉取代码
  - Task【可选】：某个阶段可以并行跑多个 Task,比如单元测试可以按包跑在不同实例上，加速运行
- 流水线有哪些阶段和环境？
  - 几种类型：
    - 单条线：只能一条线跑到底
    - 树形结构：有多个阶段，不过每个阶段可以并行跑几个任务
    - 网状结构：可以进入分支，也可以汇合
  - 哪些典型阶段（Java 为例）
    - 构建，Java Build 命令
    - 质量检查
      - 可拆分的 Task: 
        - 静态扫描（扫描源文件）：不需要构建就可以完成，比如 Checkstyle、JsLint
        - 动态扫描（扫描编译后的字节码）：Sonar、FindBugs
        - 开源检查：检查那些开源包不符合要求
        - OWASP：有很多安全类型，比如 Dependence Check 可以扫描依赖包中的 CVE
    - 自动化测试
      - 单元测试，可以按照包来拆分，并行跑
      - 集成测试（API 测试）
    - 镜像打包推送仓库
    - 部署到 DEV 环境，用于开发人员联调、验证、自测
    - 部署到 QA/ST 环境，用于 QA 执行测试用例
    - 部署到 UAT 环境，用于预发上线，模拟线上环境，或者用户验收测试
- 触发策略怎么处理？
  - 构建触发：Web Hook 代码自动提交触发流水线，如果提交频繁，可以使用节流机制
  - 部署到 DEV：自动部署或者由开发人员触发
  - 部署到 QA/ST：由测试人员才能权限触发，保证测试环境的稳定
  - 部署到 UAT：只能部署满足发版要求的版本才能部署，保证环境稳定，并且没有奇怪的测试数据
  - 其他环境：
    - PT：性能测试环境
    - 安全测试：安全测试或者渗透测试使用的环境
    - PROD：线上环境或者叫做生产环境，有些团队又叫做现网环境，需要上线申请通过的批准才能使用，有可能会使用独立的流水线和网络体系直接隔离
- 怎么和分支管理策略匹配?例如多分支流水线？
  - 策略 1，分支开发、分支发布：分支和环境一一对应，有点像 Git Flow
  - 策略 2，主干开发、分支发布：master 分支部署到 DEV、QA，release 分支发布到 UAT和 PROD
  - 策略 3，分支开发、主干发布：在流水线设计上和策略 2 类似。
  - 一般来说，新项目需要快速开发，使用策略 2，老项目需要持续运营，使用策略 1。
- 流水线很慢怎么办？
  - 使用内网、使用自己搭建的包管理仓库配置 proxy 转发
  - 使用并行的任务提高速度
  - 使用 K8s 的容器作为构建资源

## 怎么做质量扫描？
- 有那些常见的扫描工具？
  - Checkstyle
  - Sonar
  - PMD
  - JSLint
  - TSLint
  - 黑鸭开源扫描
  - OWASP
  - FindBugs
  - 单元测试质量扫描
  - ArchUnit
  - 模型检查：UML 设计和开发实现的差异
- 有那些扫描指标？
  - Checkstyle Error 必须通过
  - CVE 必须通过
  - Sonar 必须通过，指标很多
- 如何和本地开发协同？
  - Checkstyle 怎么和 IDE 格式统一？ 可以配置 editconfig 或者 Intellij 导入
  - Sonar 可以使用本地 Sonar Lint 提交前本地扫描一次

## 测试策略怎么设计？

- 一个项目有那些种类的测试？
  - Code Review
  - 代码扫描
  - 自动化单元测试
  - 自动化 API 测试，可以使用 Keta、REST Assure、MockMVC，或者契约测试
  - 普通的系统测试
  - 验收测试
  - 性能测试
  - 安全测试
- 这些测试的目标和覆盖情况（如何断言）？
  - 单元测试，目的是验证代码分支语句，建议只对核心代码做，不启动框架上下文，Mock 掉相关依赖，例如不使用 @SpringBootTest，覆盖率要求高
  - API 测试，端到端验证 API 到数据库的过程，覆盖 Happy Path，难以覆盖分支情况，比如 REST Assure 等框架
  - 契约测试，一种轻量级的 API 测试，通过 JSON 请求样例来自动断言数据字段、类型或者其他自定义的校验器，避免手动的 API 测试断言成本高。比如 API fox、Pact、Spring Contract、Cucumber API 测试。
- 测试的覆盖率如何设置？一般能做到多高？
  - 类覆盖：100%
  - 方法覆盖：60-70%
  - 分支覆盖：60-70%
- 一般测试由那些人负责？
  - Code Review：团队定期进行
  - 代码扫描：流水线配置
  - 单元测试：开发负责
  - API 测试，开发人员负责，QA 可能部分参与，某些团队 QA 负责
  - 普通的系统测试，QA 人员
  - 验收测试，产品经理或者业务人员
  - 性能测试，开发人员或者专门的性能测试团队
  - 安全测试，开发人员或者专门的安全测试团队，或者外部安全公司

## 录屏

链接: https://pan.baidu.com/s/1XD9HT_kRgH9KQAU2zhjWCg?pwd=r8df 提取码: r8df 


