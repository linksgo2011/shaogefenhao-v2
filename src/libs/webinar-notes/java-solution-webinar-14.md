---
title: 技术方案 Webinar - 国际化
date: 2023-02-04 20:53:15
sidebar: true
head:
- - meta
- name: keyword
  content: xxx
  description: xxx
---

## 问题和场景

如何对软件项目考虑好、设计完善的国际化方案？

## 国际化方案遇到的坑

- 多语言
- 时间/时区
- 币种
- 单位
- 数据本地化保护（数据隐私协议，例如 GDPR）（略）
- 跨国（区域）交易 
- 跨实例交易 （一般按照区域部署实例，略过）
- 国际数据同步
- 本地业务定制（业务差异、软件风格等）
- 本地法律（不懂，略过）
- 工作方法挑战
- 远程运维/运营支持
- 国际化的服务治理

## 如何设计多语言方案？

- 字符集如何选择？
  - UTF-8-MB4
- 语言包如何设计？
  - 文案多语言（显示的标签、菜单、按钮和提示）
    - 前端做，依赖前端框架 I18N（代码中只放入 code，让框架渲染） 实现，可以通过 API 将语言包拉取到前端。
    - 非前端内容，比如邮件、短信、导入、导出、打印任务等后端业务需要处理的部分，只能手动在代码中设计。
    - 错误码的提示也算作前端做，一般不建议通过后端反馈错误内容。
  - 字典数据多语言，比如下拉菜单
    - 方案一：设计一个字典表和语言表，字典表中只放置语言表中的标签，加载字典时，通过标签加载语言数据。
    - 方案二：每个语言存一套本地语言的字典表。
    - 推荐方案：方案一，因为字典数据是开发者在维护，避免每个语言生成一套字典，减少工作量。
  - 业务数据多语言
    - 跨国交易需要的通用数据（中国大陆地区和越南）：英语+工作语言两个字段。比如，国际结算的品类，大陆地区和越南共同使用。
    - 如果是本地化的数据：每个语言区域分开创建，就不用关注语言问题。比如，本地销售的产品、订单、工单，大陆地区、印度各自维护即可。
  - 用户内容多语言
    - 不处理
- 语言的检测和选择，以及传输、存储（怎么判定我使用那个语言？）
  - 语言的检测?
    - IP 地址
    - 用户设置
    - 浏览器设置
    - 操作系统设置
  - 多语言参数传递
    - Query
    - Header【推荐】
    - 如果后端 MQ 等其他协议使用消息头即可
  - 多语言参数的存储
    - Session
    - Cookie
    - LocalStorage【推荐】

## 如何设计多时区方案？

- 使用什么格式的数据类型支持多时区？
  - 数据库
    - long
    - DataTime
    - Timestamp 【推荐】
    - String
  - Java
    - DateTime
    - LocalDateTime （作为时间表示使用） 【推荐】
    - Instant （建议作为时间计算用）
  - 服务端时区由什么决定？数据库还是业务服务实例？操作系统？前端传入？IP 地址推测？
    - 数据库：不推荐使用数据库决策时区，因为时区往往由业务含义存在，让业务系统来做。
    - JVM：完成系统相关默认时间设置，比如 createdTime，让 Java 决策。
    - 前端过来的时间相关参数数据，按照 ISO 国际化时间为准。
  - 服务器时区需要做哪些配置？
    - JVM：不要读取操作系统时区，而是自己配置一个 JVM 参数，这样不用关心基础设施配置，比如在 Docker 的 file 中配置。
- 传输
  - 数字
  - 本地字符串
  - ISO 国际化字符串编码【推荐】
- 格式化本地化展示
  - 如果解决了上面的所有问题，使用框架格式化 ISO 国际化字符串编码即可，参考框架：dayjs、moment。


## 多币种

在国际化价格相关系统中，多币种往往使用本位币的方式计算。

本位币定义：是指使用一个基准币种来进行国际换算。

汇率的来源：通过 T+1 获取，一般云服务或者 API 市场提供了专业的汇率信息。

精度设计：多年以前使用 long 取到分的精度，目前主流使用使用 BigDecimal 对应数据库的 Decimal 存储，精度为小数点后两位，取整方式为统一向下/上/四舍五入/丢弃取，看具体场景，比如报关使用向上取。

分摊设计：最后一个部分使用减法计算，比如 100 分为三份，第一个、第二部分使用除以 3 并区两位小数精度的方式计算，最后一个使用减法计算，这样保证加总一致。

在代码中往往会封装一个币种的值对象（DDD 中的概念，不使用 DDD 的概念叫做拓展基本类型 Currency）。

## 单位

不同的国家会有不同的单位，比如在有些国家使用旧的英制单位，汽油行业使用加仑，但是目前都会存公制单位，在不同的需求下换算即可。

## 跨国（区域）交易

一般来说国际化系统都会本地部署（不一定按照国家），一般按照地区：欧洲、印度、亚太等方式划分，每个区域按照经济体或者法律适配。

这些区域往往数据是本地化的，如果需要国际交易、结算，或者总部执行审批等任务，如何设计？

方案一：设计一个通用系统，各个地方部署，通用系统中包含总部处理部分，区分数据为全局数据和本地数据，这样实现跨区域交易。

方案二：设计一个单独的国际系统，国际系统负责国际交易和结算，完全独立，这样开发量比较大。另外一套本地系统处理本地业务和交易，然后通过国际系统打通。

以物流的例子 AE（速卖通），类似方案二，订单通过跨境仓并到目标区域的跨境仓库。基本上都是方案二，方案一的开发成本较低，但是风险极高，系统复杂性高，而且把国际单和本地单混淆了。

场景：消费者购买了海外的一件商品，或者是国内商品，对于业务来说是一类订单。但是在背后发生的是，消费者向国内商业主体产生订单，如果是外贸商品会产生一笔国际贸易交易订单。这笔订单由方案二中的国际处理系统处理。

## 国际数据同步

场景：类似于私有化部署，需要在中心和本地之间同步数据，比如基础数据分发、业务统计上报。

经验不多，往往大数据平台搞定，使用类似于 Datax 传输，单独聊数据同步问题（主数据管理）。

## 本地业务定制（业务差异、软件风格等）

类似 SaaS 系统的处境，如何平衡通用能力好差异能力？

不同的区域如何处理业务差异，而且要做到持续的开发和演进，如果使用分支人工合并的方式代价极大。

- 每个区域独立开发 【不推荐】
- 每个区域一个分支，并定期维护 【不推荐】
- 全量功能 + 特性开关 【最常见的方案】
- 核心系统+元模型+插件化（设计挑战高，换种说法就是核心和应用分离）【推荐该方案】 
- 系统外的辅助增强工具 【随缘，刚好业务适合该方案】

选择这几个方案的要点：

- 企业对风险的容忍度
- 差异的程度
- 复杂性

大型公司对风险的敏感度比成本的敏感大得多。

## 工作方法挑战

对于国际化团队来说已经成为常态。

- 跨时差后的信息问题，比如别的团队加入了未知的 Bug，防止对方下班后产生了问题无法联系，阻塞当前的工作。应该有纪律的问题：
  - 编写测试，并在下班前保证 CI 构建通过。
  - 发布透明计划透明，不能擅自修改线上环境。
- 不同国家的团队竞争性问题
  - 国内团队太卷
- 拉会比较困难
  - 通过办公会议工具呼叫现在问题也不大，以及 Always on 窗口

## 远程运维/运营支持

一般都要本地化的运维/运营团队解决。

## 国际化的服务治理

国际化场景变复杂了，本本地内部搞定，没有好的方法。

## 录屏

Part1 链接: https://pan.baidu.com/s/1dn6d7LdvyDUkooX4Z-G4eA?pwd=kx92 提取码: kx92

Part2 链接：https://pan.baidu.com/s/1KvBbRx6WaXAyB5WoU8JiUw?pwd=8qkb 提取码: 8qkb 

## 潜在讨论展开话题

- 数据同步、主数据管理、基础数据分发。
- 核心系统+元模型+插件化
