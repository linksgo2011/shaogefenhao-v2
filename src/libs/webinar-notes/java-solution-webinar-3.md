---
title: 技术方案 Webinar - 微服务的结构
date: 2022-10-22 20:56:32
sidebar: true
head:
- - meta
- name: keyword
  content: 微服务的结构
  description: 微服务的结构
---

## 话题聚焦

微服务有哪些组件？他们的职责和功能是什么？业界的案例一般怎么做的？

## 典型微服务的结构

![](micro-services.png)

水平分层：

- Gateway: 流量分发，更像是基础设施，可以做一些通用的能力，不解析业务数据个，不介入业务逻辑。
- Portal Service：编排业务逻辑、聚合的业务逻辑，和场景相关。
- Domain Service：通用业务逻辑，领域内的业务逻辑，和能力相关

垂直分层：

- Portal 根据业务应用（面）分层。
- Domain 根据领域能力划分。

Gateway 和 Portal Service 的区别关键是**是否侵入业务逻辑**

## 案例输入

模式和案例补充。

李本波：

案例一：喜鹊生活，Gateway（.net ocelot，网络层，主要做路由和认证） + Portal（.net core 的项目）。

SimonHan： 

案例一：某世界 500 强，消费品牌公司系统，Portal → Azure API Management（OpenAPI 格式） → Domain Service。

案例二：没有使用 Portal，只有 Gateway（Spring Cloud Gateway），Gateway 配置了大量的白名单，很多人都在这个库，Gateway 并不能完成所有的鉴权任务，部分鉴权逻辑泄露到领域服务。编排逻辑泄露前端去了。OpenAPI 也有一个单独的 Gateway。在这个案例中，Gateway 看起来就是 Portal，一个给 Web 使用，一个给小程序使用。

## 问题

**为什么需要做微服务？**

- 规模（程序、团队、数据）太大，必须拆分
- 复用，将领域服务剥离，提供通用能力，避免重复代码
- 弹性能力不一样，比如定时任务、数据同步能明确的技术诉求，能进行拆分（不是一个必须的原因）
- 非技术因素（不讨论）

**认证检查放到哪里来做？**

auth client 的角色（解析 token 的相关职责），放到 Gateway、Portal Service？

- Gateway：比较简单的情况下对于 Portal、Domain Service 来说透明了，不关心认证，直接获取 UserContext 的身份。而且网关必须使用应用层网关，编程体验比较差。
- Portal Service：不使用 Gateway 来进行权限检查，可以在 Portal 

**应用 Gateway 和 Portal 如何选择？**

- 应用 Gateway 就是一个，做一个大的 Portal，代价是分布式单体，各个端不同的逻辑无法区分，场景逻辑可能会落入领域服务中，领域服务的复用性变差。 
- 使用 Portal 好处是每个端做了区分，可以把端的特定编排逻辑限定在 Portal 中，代价是服务会变多，失去端到端交付能力，但是获得了领域服务的复用。

推荐使用 Portal 模式。



**服务划分的方式？**

1. Portal 的划分。
2. 领域服务的划分。

**Portal 的划分原则？**

这是一个业务/产品问题/组织问题，根据系列业务和流程的集合划分，Portal 的划分比较灵活。

划分案例 1：送菜的产品，商户（买家）可以在后台看的订菜数据，给餐厅的业务人员用的。老板还需要一个手机端，不需要订菜，只需要看门店和总体的报表。

划分案例 2：家装业务线不同，比如根据场景和业务流程不一样划分，比如精装、软装、设计，都会产生共享的订单数据。

划分案例 3: 某保险公司收购了大量的第三方品牌，为了让原有的业务体验一致，使用了不同的 Portal API，但是将数据导入到共同的领域服务中。

Portal 主要参考产品/业务需求来，和前端项目对应，和端相关，表达业务场景，一般不追求复用。

**领域服务划分方式？**

平常我们讨论的微服务划分，默认就只讨论了领域服务划分。

- 根据数据和状态的依赖关系来划分。方法有：事件风暴、8xflow、彩色 UML、名词法、数据模型反推、原型图倒推、用例流、聊和自己拍脑门的。
- 数据的依赖关系，需要大量的数据同步、强数据一致性处理，把数据的依赖关系先整理参考一下，并验证上下文划分。
- 是否需要关心界面和信息架构？不能以界面驱动，但是需要关心界面，**界面是产品人员的思维呈现**。没有界面建模的关系非常容易弄错，需要将模型和界面验证。

模型描述软件空间结构，流程体现时间结构，才能构成完整的时空结构。

**聚合查询怎么实现？**

比如，比如订单上面有产品信息、卖家信息怎么处理？

分类：

1. 单个查询或无分页条件的查询。
   2. 通过 Portal，多次 RPC 调用
   3. 冗余数据，比如订单上的商品字段
   4. 前端放到详情页面展示，或者 Hover 后展示
2. 分页、搜索查询。举例：**查询库存不为 0 的商品列表，条件在库存上，但是主要的数据在商品，并且可售状态。**
   3. 冗余表来实现，相对冗余比冗余字段简单，准实时，可以使用 ETL 工具，数据同步平台
   4. 在库存上冗余商品信息，字段少的可以这样，比如可售状态字段可以同步到库存服务
   4. ES，一般需要自己使用 MQ 推送
   5. 合并微服务
3. 统计查询。
   4. 搭建一个报表系统（帆软、永红、UReport、EasyBI、积木报表）从从库读取，将多个数据库合并到一个从库上统计
   5. OLAP 数据库，比如 PG，类似从库
   6. 业务服务直接从库跨库查询
   7. 数据中台服务，大数据平台实现，然后返回给业务服务，报表服务展示数据。
      8. 各个领域服务调用平台，回写到自己的库
      9. 各个领域服务调用平台，平台写入统一的报表库，业务服务也可以读取报表库

**报表和统计的方案，报表组件在微服务中的位置？**

它是一个很难被归类的服务，类似 Auth，可以看做一套 Portal 或者应用，但是可以连接从库的技术组件。

**Portal 的实现方式，比如框架？**

特点是：1. 可以自定义编排业务 2. 转发（大部分请求直接转发）

- Zuul
- Nodejs/PHP/JSP
- Spring Cloud Gateway
- Spring Boot 裸项目和 HTTP Client

Portal 使用哪种 API 风格？

1. 资源风格（RESTFul），例如: POST /tokens 参考：https://jsonapi.org/
2. 命令风格 (RPC)，例如：login

- 方案 1：全部使用资源风格（推荐）
- 方案 2：前端-portal 使用命令风格，portal-domain 之间使用资源风格
- 方案 3：全部使用命令风格（不推荐，不常见）

**微服务的组件和团队组织如何对齐？**

非常困难的问题（屠龙技，需要上层设计权责利关系），需要考虑问题：

1. 需求哪个团队承接和排期。
2. 服务那些团队可以负责 own。
3. Code Review。

- 方案1：代码公有制。不区分团队、代码仓库之间的关系，根据领取不同的任务来进入需要的代码仓库。可能出现摩擦和冲突。（比较少，小公司）
- 方案2：领域服务每个服务一个团队 + 前端中的相应模块和上下文对应，优先考虑端到端交付，可能出现重复建设的问题，复用性降低。（国内目前这个比较多）
- 方案3：领域服务每个服务一个团队，Portal + 对应的前端一个团队，领域服务团队承接 Portal 团队的需求，端到端交付受到影响，依赖领域服务的先行和排期，复用性好。（海外比较多）

康威定律描述了一个现象，但是没有给出解决方案。**端到端开发的能力和领域能力复用的矛盾。** CTO 需要关注的几个对齐问题：

- 任务划分
- 功能划分
- 微服务划分 
- 代码库划分 (和微服务对齐)
- 数据库划分（和微服务对齐）
- 团队划分

**其他的模式？**

- Portal根据领域服务对齐划分，而不是和场景划分。

**服务之间的变更如何处理？**

1. Sementic Version API Sdk 方案，兼容中版本即可。
2. API 版本握手，如果握手失败，强制升级。

**数据库如何扩展？**

微服务本身就是数据的垂直扩展，在微服务内部依然可以水平拓展。

## 一些共识

**网关**

分发流量的技术组件，和业务逻辑无关。

- 网络层网关：Ingress、Nginx、Kong、Traffic，根据 URL、IP 分发流量。
- 应用层网关：Spring Cloud Gateway、Zuul，根据业务规则、版本、用户群分发流量。

网络层的网关可以通过一些插件来变成应用层网关，比如通过 Lua 脚本编写插件。

**核心矛盾**

端到端开发的能力和领域能力复用的矛盾。一旦复用，就要忍受耦合的代价，复用是一种诱惑。

## Parking lot for next time 

- 数据权限和功能权限怎么区分
- 微服务中团队分工和职责
- 认证和授权

