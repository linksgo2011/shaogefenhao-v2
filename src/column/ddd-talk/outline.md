---
title: 闲话 DDD：业务系统开发的逻辑
sidebar: false
---

## 大纲

### 01 说人话，什么是 DDD， DDD 是一门技术吗？

- 希望通俗的方式分享 DDD 的一些心得
- 收银系统，业务复杂之后的困境
    - 在我之前公众号的文章中，我拿这个做了很多次例子
    - 我称之为不长眼的新手程序员，在订单删除菜品的时候忘记重新计算，导致业务不一致
    - 其实 DDD 特别简单，就是设计好业务模型，然后利用业务模型来提高代码的可读性、可维护性和数据的一致性
- 我在 thoughtworks 搞了 DDD 社区，对 DDD 进行规范化、标准化，不过并没有太成功 可以参考 https://domain-driven-design.org/
- 我也在 51cto 上和同事做了付费课程，有几万人次的购买
- 在很多个公司做了 DDD 的咨询
- 很多公司把 DDD 当作一种技术拿来培训、面试，其实它很难说是一种技术，更像是一些编程思想。理解 DDD 的人更像是对现实世界的一种映射，而不是一种具体的实现。
- 后来我把 DDD 的思想做了延伸，把我的心得写成了一本电子书《程序员的认知心得》https://renzhi.shaogefenhao.com/ 大家有兴趣可以去阅读一下。
- 我希望把 DDD 做成一个通俗的谈话系列，所以我也不打算使用 PPT，就用白板轻松的聊聊
- DDD 很多概念比较晦涩难懂，比如值对象就很难被理解（也有翻译的原因），所以我不打算按照培训的思路来制作这个视频，而是把每个概念放到具体的场景中，并拆分成不同的小节，其实非常容易理解，因为这些概念出现有它的特定意义

### 02 事务脚本VS模型驱动，以及充血贫血之争

- DDD 写代码和不是 DDD 风格写代码的显著区别是什么
    - 事务脚本
    - Smart UI 
    - 模型驱动
- 模型驱动的意义，需要重新理解面向对象。参考认知心得： https://renzhi.shaogefenhao.com/#_3_2_%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9E%8B
    - 数据 + 算法 = 程序
    - 结构化的程序
    - 面向对象的程序。理解面向对象需要到生活中去，观察玩泥巴的小孩。他们用泥巴创造出一个城堡前，泥土就好像计算机世界中的数据，将泥土组织成有清晰边界的物品就是对象。我们为了描述这类对象，就需要给它起个名字才能交流。类可以对应现实中的一个概念，很多面向对象的书籍并没有点破这一点。
- 为什么感受不到以 DDD 风格写代码？因为大部分人都基本上以面向对象的方式在写代码，只是不能完全理解面向对象，特别是 java 中的面向对象。
- 所以 DDD 中会有一个充血模型、贫血模型的概念。
    - 充血：一个对象需要包含一些处理自身状态的逻辑，比如订单对象需要包含计算金额的逻辑
    - 贫血：一个对象只需要包含数据，而不需要包含处理数据的逻辑，比如订单对象只需要包含订单号、金额、状态等数据
    - 涨血：对象的行为超出了自己的范围，比如订单对象需要包含支付、取消等行为，这些行为超出了订单对象的范围，应该放到订单服务中处理。
- 这里我写过一篇文章驳斥无脑的充血主义者。你要求一张桌子能把自己搬到楼上去，这是不符合面向对象语义的。
- 顺便题外话，面向对象只是一个比喻。你强行把桌子可以行走建模出来，也不是不可以，只是会非常不合适。

### 03 聚合，以及如何对大聚合进行拆分

- 其实 Eric 不是神，聚合这个概念在 DDD 和 UML 的术语体系中是不匹配的，聚合更应该是对象的组合关系
- 从关系模型，到对象树模型，再到对象森林，我们就能知道聚合的意义了
- 几个概念
    - 实体 Entity
    - 聚合根 Aggregate Root
- 了解聚合这个概念的好处
    - 用聚合可以保持业务逻辑的一致性
    - 用聚合可以让对象解偶
    - 用聚合可以降低人的心智负担，把大量无关的对象分门别类
    - 用聚合可以指导进一步设计，比如指导控制器、仓储、服务的创建，都可以和聚合一一对应，聚合是程序的骨架
- 聚合的几个问题
    - 聚合的大小
    - 实体在聚合中的归属问题：一个实体只能属于一个聚合根，不能跨聚合根。比如订单行和物流单行，中的字段看似非常相似，其实绝对不能搞到一起。
    - 批量操作的导致的问题
        - 如果是业务逻辑，需要用聚合一个一个处理
        - 如果本身就是搬运数据，其实模型是不可见的，直接批量操作数据
    - 聚合过大时，如何拆分
        - 对聚合根进行拆分
- 总结
    - 聚合是设计出来的，在很多时候需要取舍
    - 一般来说是整存整取，但只要保证语义也可以对聚合根进行批量操作
    - 经验：对象树的深度不要超过 2 层，宽度不要超过 4-5 个对象

参考资料：https://shaogefenhao.com/column/ddd/19.tactical-modeling-principles.html

### 04 动手写代码：DDD 的分层架构

- DDD 圈子中经常讨论的几种代码分层结构
    - MVC 架构
    - 四层架构（Eric 书中的架构模式）
    - 六边形架构（洋葱架构）
    - 整洁架构
    - 我整理非常细致的架构分层规则
    
- 实际项目上
    - ORM 选择 Mybatis Plus 用的比较多， 兼顾方便和灵活性，Repository 这一层自己实现
    - ApplicationService 和 DomainService 分开，ApplicationService 处理场景用例，DomainService 处理通用业务逻辑
- 经验
    - 一个聚合根对应一个控制器，控制器中包含场景用例的方法
    - 一个聚合根对应一个服务，服务中包含业务逻辑方法
    - 一个聚合根对应一个仓储，仓储中包含 CRUD 方法
- 总结
    - 提前设计一个打样工程非常有必要，不然很多人同时写代码会不一致
    - 避免千层饼架构，每一层尽可能要有意义，避免千层饼架构
    - 注意微服务之间的宏观架构和微服务内的微观架构的指责区分

### 05 值对象，其实就是“字段包”

- 理解值对象
    - 实体有 ID 值对象没有 ID
    - 值对象的属性是不可变的，一旦创建就不能改变
    - 值对象的相等性是基于属性值的，而不是引用
    - 通俗来说值对象就是属性包
- 为什么需要用值对象：减少重复字段的定义
- 项目中真实的例子
    - 订单中的地址信息，包括国家、省份、城市、区县、街道、详细地址、邮政编码等
    - 金额：包括金额值和货币单位
    - 身份证号：号码本体即全部含义，无需主键，可跨表复用
    - 坐标点：经度 + 纬度，可整体替换，不可“部分修改”
    - 时间段：开始时间 + 结束时间，常用于排班、价格策略等场景
- 在数据库中如何存储值对象，这两种方法按情况使用
    - 可以将值对象的属性作为独立的字段存储在数据库表中 （使用映射工具，自动映射展开）
    - 也可以将值对象作为 JSON 或 XML 格式的字符串存储在数据库表中 （序列化成 JSON）

### 06 限界上下文：逻辑边界

- 为什么需要限界上下文？
    - 通俗来说就是根据模型划分出逻辑边界，上下文中装的是代表系统状态的实体、对象
    - 限界上下文是 DDD 中非常重要的一个概念，它是一个边界，用来划分不同的业务领域。
    - 在单体中，划分模块
    - 在微服务中，限界上下文往往对应一个服务
    - 上下文之间最终一致性事务，上下文内本地事务
- 划分限界上下文的参考是什么？
    - 识别上下文可以从概念的二义性着手，比如商品的概念在物流、交易、支付含义完全不一样，但具有不同内涵和外延，实际上他们处在不同上下文。
- 战略设计和战术设计
    - 在 DDD 中把上下文这个层次叫做战略设计
    - 把上下文内的开发过程叫做战术设计
- 总结
    - 限界上下文实际上是“设计”而不是“分析”，要注意这一点，上下文是一个解决方案，而不是需求问题
    - 上下文划分与大小关系不大，与是否能相对独立提供服务比较大
    - 上下文划分注意相互依赖的问题
    - 在实际操作的时候，可以用聚合来划分，找核心模型，然后来划分，不然项目太大模型太多不好操作

### 07 DDD 八股文

- 程序员可能不太喜欢但管理者非常关心的概念
    - 问题空间、解决方案空间
    - 战略设计、战术设计
        - 战略设计要求把技术规划做好，在开始写代码之前就需要把上下文和微服务划分合理，还有核心模型，这些改动起来比较麻烦
        - 战术设计是指把上下文内的开发过程叫做战术设计
    - 建模原则
        - 通用语言: 语言决定了认知边界，对模型正确的术语定义就已经成功了一半
        - 聚焦核心域：只做最重要的事情
        - 协作共创：必须从业务中提炼技术方案，共识大于正确，否则技术毫无意义
- 为什么我还要讲这部分？
    - 你不能永远站在程序员视角思考问题，需要从市场、技术管理的角度
    - 康威定律是马尔文康威1967提出的：“设计系统的架构受制于产生这些设计的组织的沟通结构。”
- 总结
    - 领导的关注点在于比起架构是否干净合理，更重要的是大型系统团队之间如何协作
    - 这是架构师在很多公司需要面对最严峻的问题

### 08 DDD 的建模过程

- 系统词汇法（OOA）
    - 寻找系统中的客体，表达状态的被操作者
- 个人 SOLO：用例分析方法
    - 通过原型图整理，用例（UseCase）是对一个活动者使用系统的一项功能时所进行的交互过程的一个文字描述。
    - 在用户故事中寻找名词（这块现在可以通过 AI 实现）
    - 分析参与者、用例关系、名词（模型）之间的关系，辨析模型是否正确
- 彩色建模
    - 四色建模法其实是以数据驱动，通过挑选一些关键数据（类似于办事过程中的存根），来还原整个业务流程。然后基于这个线索，找出时标性对象（moment-interval）、实体（party/place/thing）、角色（Role）、描述对象（description）。
    - 用四种颜色标注这些对象，参考：：
        - 红色：时标性对象（moment-interval）
        - 绿色：实体（party/place/thing）
        - 蓝色：角色（Role）
        - 黄色：描述对象（description）
    - “任何业务事件都会以某种数据的形式留下足迹”。
- 协作建模：事件风暴
    - 参考: https://domain-driven-design.org/zh/ddd-design-workshop-guide.html
    - 工作坊本质上是拉长人们思考的时间，更加深度的思考问题
    - “事件是系统状态变化的关键帧”。
- 总结
    - 本质上是通过不同的线索，寻找对象。参考：建模方法元模型 https://mp.weixin.qq.com/s/B3tJhSh_Az5g8sOaMVZtUA

### 09 DDD在敏捷团队中如何应用

- 项目规划阶段：战略设计
    - https://mp.weixin.qq.com/s/_o9dM8_lVyC9nwtSrM37KQ
- 日常迭代阶段：战术设计
    - https://mp.weixin.qq.com/s/m_sRyJedAydk0b-0VVa3tw

### 10 DDD 概念全景回顾【阶段性完结】

- 参考: https://domain-driven-design.org/zh/ddd-concept-reference.html

### 11 为什么我要求团队不使用多对多关系？

### 12 DDD 的项目性能如何优化？

### 13 有必要每个服务创建一个接口吗？

### 14 规格模式和策略模式如何应用？

### 15 Repository 中如何解决 1+N 更新的问题？

### 16 DDD项目单元测试如何做？

### 17 DDD架构守护，ArchUnit 的使用

### 18 对象转换工具

### 19 建议大家把分析和设计分开

### 20 场景和复用分离：应用系统终极模式


## 待解决的问题

1. 比如：ddd 到底在解决什么问题？业务价值是什么？
2. 需要一个DDD系统的知识培训
3. 读模型怎么构建，很多用户填写的字段对聚合无任何业务意义的，但是需要展示，新建或者更新的时候要直接传递到聚合，再通过事件发送出去，构建读模型吗？
4. io（王飞） 事件风暴怎么搞？这是ddd里快速搞定业务的标准方法。但我一直觉得跟我们的文化有点不合。有搞得起来，搞得好的谈谈心得吗
5. 【为什么学 DDD 之间的人互相看不起】说实话 DDD 这个东西的门槛太低了，每个人都可以来讲自己的理解，所以圈子里面很多人就相互看不起，甚至一个公司内部也是。所以我之前想在公司项目之间统一 DDD 的实践失败了。搞不定的来找我就行，别被DDD 这些概念套进去了。甚至有人专门从其它城市跑过来找我讨论（辩论）DDD
6. 多对多关系如何拆解
7. 领域驱动设计集成敏捷开发过程
