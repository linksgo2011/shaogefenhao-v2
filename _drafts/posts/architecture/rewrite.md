---
title: 系统设计 | 遗留系统的重写策略和技巧
date: 2024-07-13 16:04:32
sidebar: auto
category: 
  - 软件架构
head:
  - - meta
    - name: keyword
      content: 关键字
      description: 描述
---

在过去几年完整经历过几个项目的重写过程，我把这些过程中的经验整理下来，可能大家或者我自己以后也用得上。这两年基本没有创新的软件项目了，要么就是在旧的系统上修修补补（添加新的功能或者重构），要么就是重写。

下面的内容均为经验之谈。

## 01 项目重写的工作策略

这部分内容有点长，拆分出去了。参考文章《系统设计 | 如何了解一个不熟悉的系统？》

### 理解遗留系统的业务规则

重写遗留系统时，有新的业务需求进来，同时需要把原有系统的业务规则找出来作为需求开发新的系统，这是一个巨大的挑战。这对于业务分析师就犯难了（BA），有很多业务规则根本找不到了，以前的设计文档就算有，也可能都过时了。

在遗留系统中，有可能很多业务规则是通过做的临时修改，在看不到代码的情况下如何把这些业务规则找出来？

我们尝试过好几个办法：

1. 对遗留系统进行一次完整的测试，根据测试的结果和用例的执行记录来收集业务规则。这样做的好处是，用例也可以作为新系统测试时使用。
2. 让业务分析师和开发人员结对，对代码库进行走查。

拿到遗留系统的业务规则后，不一定能直接使用在新的系统中，可能需要做一些调整，因为很多业务规则过时了，或者非常冗余，可以采用更加直接的方案。

### 遗留系统维护和重写项目并行

另外一个挑战遗留系统重写的项目管理问题。在遗留系统重写过程中，我们可能会增加额外的开发人员，但也需要仍然维护遗留系统，增加一些微小的调整，这些调整也需要合并到正在重写的新系统中。

如何平衡这类需求？

1. 遗留系统维护的团队可以使用看板管理模式，即通过需求流水线，没有固定的迭代，接收需求并开发上线。
2. 遗留系统重写团队采用敏捷迭代式的管理模式，如果这类需求也需要在重写的系统中处理，安排在下一个迭代。

### 对新系统的规划

在开启遗留系统重写前，最好做一个规划，避免做出来的新系统又变成一个遗留系统：

1. 梳理系统的各个服务或者组件，包括服务名、关键领域模型、关键数据库模型、API。
2. 整理一个打样工程（可以参考历史文章，我整理过一个打样工程），打样工程作为新系统各个服务的模版，把常见一套 CRUD 的模式设计好。例如如何实现分页查询、文件上传、导入导出、单元测试和 API 测试等。打样工程是新启动一个项目非常重要的参考，当多个人开始并行开发时，能保持代码风格和模式基本类似。
3. 提前整理一个公共包，把各个服务能复用的代码抽象到公共包中，在后期修改的时候只需要操作一次。

在做系统规划时的教训：

1. 避免选择非常“华丽”的技术，越华丽的技术背后需要承担的代价也越大。比如，现在很多架构师动不动就是 Clean Architecture。
2. 期待一开始就做出完美的详细设计。长期的工作经验告诉我们，这是做不到的，在规划期间只能挑重点，把核心模型、服务边界定下来，而更详细的设计需要放到实现前（迭代前）来说。

### 多部门协同

在重写项目启动前就需要准备多部门沟通了，否则在后期非常被动。

1. 提前约定 API。越大的系统上下游集成点越多，大的系统甚至多大上百个 API 集成点，所以需要提前找到这些 API 的联系人、上线时间。   
2. 提前约定切换策略，如果切换策略对上下游有改造成本，需要提前沟通。
3. 测试和联调计划。
4. 上线计划。

### 重写项目的测试和验证策略

1. 功能一致性验证
2. 数据一致性验证

## 02 新旧系统切换策略

新旧系统同时允许的关键点：避免对数据的同时更新而产生的冲突。

这部分内容有点长，拆分出去了。

参考文章：

- 《系统设计 | 遗留系统改造和迁移模式》
- 《系统设计 | 数据同步（全量+增量）方案选型》

### 上下游系统切换

### 回滚方案和异常预案

### 系统切换和业务割接